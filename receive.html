<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <video id='remoteVideo' autoplay playsinline muted style="width: 100%; height: 100%;"></video>
    <p id='log'>Logs</p>
</body>
<script>
const remoteVideo = document.getElementById('remoteVideo');
let peerConnection;


let signaling;
try {
  signaling = new WebSocket('wss://ws.tc-net.bzy.li');
  alert('websocket created');
} catch (e) {
  alert('exception: ' + e.message);
}
signaling.onopen = e => {
  signaling.send(JSON.stringify({type : 'ready'}));
  console.log('sent ready message');
}

signaling.onmessage = e => {
    
    const message = JSON.parse(e.data);
    switch (message.type) {
        case 'offer':
      handleOffer(message);
      break;
    case 'answer':
      handleAnswer(message);
      break;
    case 'candidate':
      handleCandidate(message);
      break;
    case 'ready':
      // A second tab joined. This tab will initiate a call unless in a call already.
      if (peerConnection) {
        console.log('already in call, ignoring');
        return;
      }
      console.log('initiating connection');
      break;
    case 'bye':
      if (pc) {
        hangup();
      }
      break;
    default:
      console.log('unhandled', e);
      break;
  }
};

async function hangup() {
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
};

function createPeerConnection() {
    peerConnection = new RTCPeerConnection({iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, {urls: 'turn:tc-net.bzy.li:3478', username : 'test', credential :'test'}]});
    peerConnection.oniceconnectionstatechange = () => console.log('ICE state:', peerConnection.iceConnectionState);
    peerConnection.onicecandidate = e => {
        const message = {
            type : 'candidate',
            candidate : null,
        };
        if (e.candidate) {
            message.candidate = e.candidate.candidate;
            message.sdpMid = e.candidate.sdpMid;
            message.sdpMLineIndex = e.candidate.sdpMLineIndex;
        }
        console.log(message);
        signaling.send(JSON.stringify(message));
    };
    peerConnection.ontrack = e => remoteVideo.srcObject = e.streams[0];
    

};

async function handleOffer(offer) {
  if (peerConnection) {
    console.error('existing peerconnection');
    return;
  }
  await createPeerConnection();
  await peerConnection.setRemoteDescription(offer);

  const answer = await peerConnection.createAnswer();
  signaling.send(JSON.stringify({type: 'answer', sdp: answer.sdp}));
  await peerConnection.setLocalDescription(answer);
}

async function handleAnswer(answer) {
  if (!peerConnection) {
    console.error('no peerconnection');
    return;
  }
  await peerConnection.setRemoteDescription(answer);
}

async function handleCandidate(candidate) {
  if (!peerConnection) {
    console.error('no peerconnection');
    return;
  }
  if (candidate.candidate) {
    console.log('adding new candidate');
    const iceCandidate = new RTCIceCandidate({
        candidate: candidate.candidate,
        sdpMid: candidate.sdpMid,
        sdpMLineIndex: candidate.sdpMLineIndex
    });
    await peerConnection.addIceCandidate(iceCandidate);
  }
}

</script>
</html>
